<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garage Bars ¬∑ Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #0c0f0c; --card: #141a14; --card-hover: #1a221a; --border: #1e2e1e;
            --border-hover: #2e4a2e; --text: #e4ede4; --text2: #8fa88f; --muted: #5a7a5a;
            --accent: #ff6b35; --accent-soft: rgba(255,107,53,0.1);
            --teal: #5aedc5; --teal-soft: rgba(90,237,197,0.1);
            --gold: #f0b860; --purple: #b07aff; --green: #4ad484; --red: #ff5a5a;
            --r: 14px; --rs: 10px;
            --font: 'DM Sans', -apple-system, sans-serif; --mono: 'Space Mono', monospace;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100vh; padding: 24px; line-height: 1.5; }
        .container { max-width: 1600px; margin: 0 auto; }
        header { background: var(--card); border: 1px solid var(--border); border-radius: var(--r); padding: 26px 30px; margin-bottom: 22px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        h1 { font-size: 1.65rem; font-weight: 700; color: var(--text); letter-spacing: -0.02em; }
        h1 span { color: var(--accent); }
        .last-update { font-family: var(--mono); font-size: 0.76rem; color: var(--muted); margin-top: 5px; }
        .filters { background: var(--card); border: 1px solid var(--border); border-radius: var(--r); padding: 16px 20px; margin-bottom: 26px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
        .filters select, .filters input { font-family: var(--font); background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 8px 13px; border-radius: var(--rs); font-size: 0.86rem; transition: border-color 0.2s; color-scheme: dark; }
        .filters select:focus, .filters input:focus { outline: none; border-color: var(--accent); }
        .filters label { color: var(--text2); font-size: 0.8rem; font-weight: 500; margin-right: 3px; }
        .section-title { color: var(--text); font-size: 1.05rem; font-weight: 600; margin: 36px 0 16px 0; letter-spacing: -0.01em; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 14px; margin-bottom: 8px; }
        .kpi-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--r); padding: 20px; transition: all 0.2s ease; }
        .kpi-card:hover { border-color: var(--border-hover); transform: translateY(-2px); }
        .kpi-card.hi { border-color: var(--accent); background: linear-gradient(135deg, var(--accent-soft), transparent); }
        .kpi-label { font-size: 0.74rem; color: var(--text2); text-transform: uppercase; letter-spacing: 0.07em; font-weight: 500; margin-bottom: 9px; }
        .kpi-value { font-family: var(--mono); font-size: 1.6rem; font-weight: 700; color: var(--teal); letter-spacing: -0.02em; }
        .kpi-value.or { color: var(--accent); }
        .kpi-sub { font-size: 0.78rem; color: var(--muted); margin-top: 5px; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(560px, 1fr)); gap: 18px; margin-bottom: 8px; }
        .chart-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--r); padding: 22px; }
        .chart-card.full-width { grid-column: 1 / -1; }
        .chart-title { font-size: 0.95rem; font-weight: 600; margin-bottom: 16px; color: var(--text); }
        .chart-container { position: relative; height: 340px; }
        .chart-container.tall { height: 420px; }
        .weekly-table { width: 100%; border-collapse: collapse; }
        .weekly-table th { font-size: 0.76rem; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.05em; padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border); }
        .weekly-table td { padding: 11px 14px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .weekly-table tr:last-child td { border-bottom: none; }
        .weekly-table tr:hover { background: rgba(255,255,255,0.015); }
        .change-positive { color: var(--green); font-weight: 600; }
        .change-negative { color: var(--red); font-weight: 600; }
        .change-neutral { color: var(--muted); }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(270px, 1fr)); gap: 14px; }
        .info-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--r); padding: 18px; display: flex; align-items: center; gap: 15px; transition: border-color 0.2s; }
        .info-card:hover { border-color: var(--border-hover); }
        .info-card-emoji { font-size: 2rem; }
        .info-card-data { flex: 1; }
        .info-card-label { font-size: 0.82rem; color: var(--text2); margin-bottom: 3px; }
        .info-card-value { font-family: var(--mono); font-size: 1.4rem; font-weight: 700; color: var(--teal); }
        .info-card-value.orange { color: var(--gold); }
        .info-card-detail { font-size: 0.76rem; color: var(--muted); margin-top: 3px; }
        .locations-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .location-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--r); overflow: hidden; transition: border-color 0.2s; }
        .location-card:hover { border-color: var(--border-hover); }
        .location-header { background: linear-gradient(135deg, var(--accent), #d45520); padding: 17px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .location-name { font-size: 1.08rem; font-weight: 600; }
        .location-body { padding: 17px 20px; display: none; }
        .location-body.active { display: block; }
        .location-stat { display: flex; justify-content: space-between; padding: 9px 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .location-stat:last-child { border-bottom: none; }
        .stat-label { color: var(--text2); }
        .stat-value { color: var(--teal); font-weight: 600; font-family: var(--mono); font-size: 0.88rem; }
        .detail-table { background: var(--card); border: 1px solid var(--border); border-radius: var(--r); margin-bottom: 24px; overflow: hidden; }
        .detail-table table { width: 100%; border-collapse: collapse; }
        .detail-table th { background: var(--accent); color: white; padding: 13px 15px; text-align: left; font-weight: 600; font-size: 0.84rem; }
        .detail-table td { padding: 10px 15px; border-bottom: 1px solid var(--border); font-size: 0.86rem; }
        .detail-table tr:hover { background: rgba(255,255,255,0.015); }
        .detail-table tr:last-child td { border-bottom: none; }
        .toggle-icon { transition: transform 0.3s ease; font-size: 0.8rem; }
        .toggle-icon.rotated { transform: rotate(180deg); }
        @media (max-width: 768px) { body { padding: 14px; } .charts-grid, .locations-grid, .info-grid { grid-template-columns: 1fr; } h1 { font-size: 1.3rem; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>üç∫ <span>Garage Bars</span> ¬∑ Dashboard</h1>
                <div class="last-update" id="lastUpdate">Cargando...</div>
            </div>
        </header>
        <div class="filters">
            <div><label>Per√≠odo:</label><select id="periodFilter"><option value="1">√öltimo d√≠a</option><option value="7">√öltimos 7 d√≠as</option><option value="14">√öltimos 14 d√≠as</option><option value="30">√öltimos 30 d√≠as</option><option value="all" selected>Todo</option></select></div>
            <div><label>Local:</label><select id="locationFilter"><option value="all">Todos los bares</option></select></div>
            <div><label>D√≠a de semana:</label><select id="dayOfWeekFilter"><option value="all">Todos</option><option value="1">Lunes</option><option value="2">Martes</option><option value="3">Mi√©rcoles</option><option value="4">Jueves</option><option value="5">Viernes</option><option value="6">S√°bado</option><option value="0">Domingo</option></select></div>
            <div><label>D√≠a espec√≠fico:</label><input type="date" id="specificDate"></div>
            <div><label>Desde:</label><input type="date" id="dateFrom"></div>
            <div><label>Hasta:</label><input type="date" id="dateTo"></div>
        </div>
        <div class="kpi-grid" id="kpiGrid"></div>
        <h2 class="section-title">üìä √öltimo Cierre vs Mismo D√≠a Semana Pasada</h2>
        <div class="chart-card" id="lastDayCompCard"><div id="lastDayComparison"></div></div>
        <h2 class="section-title">üìÖ Semana Completa vs Semana Anterior</h2>
        <div class="chart-card" id="fullWeekCompCard"><div id="fullWeekComparison"></div></div>
        <h2 class="section-title">üé´ Ticket Promedio por Bar</h2>
        <div id="ticketPerBar"></div>
        <h2 class="section-title">‚è±Ô∏è Duraci√≥n Promedio de Turno</h2>
        <div id="durationPerBar"></div>
        <h2 class="section-title">üìà Gr√°ficos</h2>
        <div class="charts-grid">
            <div class="chart-card full-width"><h3 class="chart-title">Evoluci√≥n de Ventas por D√≠a</h3><div class="chart-container tall"><canvas id="salesTrendChart"></canvas></div></div>
            <div class="chart-card"><h3 class="chart-title">Ventas por D√≠a de Semana</h3><div class="chart-container"><canvas id="dayOfWeekChart"></canvas></div></div>
            <div class="chart-card"><h3 class="chart-title">Top 10 Mejores D√≠as</h3><div class="chart-container"><canvas id="topDaysChart"></canvas></div></div>
            <div class="chart-card"><h3 class="chart-title">Ventas por Local</h3><div class="chart-container"><canvas id="salesByLocationChart"></canvas></div></div>
            <div class="chart-card"><h3 class="chart-title">M√©todos de Pago</h3><div class="chart-container"><canvas id="paymentMethodsChart"></canvas></div></div>
            <div class="chart-card full-width"><h3 class="chart-title">Comparativa Turnos ¬∑ Growler Cafe</h3><div class="chart-container"><canvas id="shiftsComparisonChart"></canvas></div></div>
        </div>
        <h2 class="section-title">üèÖ Mejores D√≠as por Bar</h2>
        <div class="charts-grid" id="bestDaysPerBarGrid"></div>
        <h2 class="section-title">üèÜ Top 5 Productos por Bar</h2>
        <div class="charts-grid" id="productsGrid"></div>
        <h2 class="section-title">üìç Detalles por Local</h2>
        <div class="locations-grid" id="locationsGrid"></div>
        <div class="detail-table"><div style="padding:18px 22px;font-weight:600;font-size:0.95rem;">Todas las Ventas</div><table id="detailTable"><thead><tr><th>Fecha</th><th>Local</th><th>Turno</th><th>Ventas</th><th>Tickets</th><th>Efectivo</th><th>Tarjeta</th><th>Otros</th></tr></thead><tbody></tbody></table></div>
    </div>
    <script>
        let dashboardData = null;
        let charts = {};
        const locationColors = { 'GG Vol 4': '#ff6b35', 'GG Vol 2': '#5aedc5', 'COLEGIO': '#f0b860', 'GROWLER CAFE': '#4ad484', 'GROWLER VIA VIEJA': '#b07aff' };
        const fmt = (n) => '$' + n.toLocaleString('es-AR', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        Chart.defaults.color = '#8fa88f';
        Chart.defaults.borderColor = '#1e2e1e';
        Chart.defaults.font.family = "'DM Sans', sans-serif";

        async function loadData() {
            try {
                const response = await fetch(`dashboard_data.json?t=${new Date().getTime()}`);
                dashboardData = await response.json();
                dashboardData.sales_data = dashboardData.sales_data.map(sale => ({
                    ...sale, total_sales: sale.total_sales / 100, cash_sales: sale.cash_sales / 100,
                    card_sales: sale.card_sales / 100, transfer_sales: sale.transfer_sales / 100,
                    mercadopago_sales: sale.mercadopago_sales / 100, other_sales: sale.other_sales / 100,
                    salon_sales: sale.salon_sales / 100, counter_sales: sale.counter_sales / 100
                }));
                initDashboard();
            } catch (error) { console.error('Error cargando datos:', error); alert('Error cargando datos del dashboard'); }
        }

        function initDashboard() {
            document.getElementById('lastUpdate').textContent = `√öltima actualizaci√≥n: ${new Date(dashboardData.last_updated).toLocaleString('es-AR')}`;
            const locationFilter = document.getElementById('locationFilter');
            locationFilter.innerHTML = '<option value="all">Todos los bares</option>';
            Object.keys(dashboardData.locations).forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = `${dashboardData.locations[loc].emoji} ${loc}`;
                locationFilter.appendChild(option);
            });
            ['periodFilter','locationFilter','dayOfWeekFilter','specificDate','dateFrom','dateTo'].forEach(id =>
                document.getElementById(id).addEventListener('change', updateDashboard));
            updateDashboard();
        }

        function getFilteredData() {
            let data = [...dashboardData.sales_data];
            const locationFilter = document.getElementById('locationFilter').value;
            const periodFilter = document.getElementById('periodFilter').value;
            const dayOfWeekFilter = document.getElementById('dayOfWeekFilter').value;
            const specificDate = document.getElementById('specificDate').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            if (locationFilter !== 'all') data = data.filter(d => d.location === locationFilter);
            if (specificDate) data = data.filter(d => d.date === specificDate);
            if (dayOfWeekFilter !== 'all') {
                const targetDay = parseInt(dayOfWeekFilter, 10);
                data = data.filter(d => new Date(d.date + 'T00:00:00').getDay() === targetDay);
            }
            if (!specificDate && periodFilter !== 'all') {
                const periodDays = parseInt(periodFilter, 10);
                const cutoffDate = new Date(); cutoffDate.setHours(0,0,0,0); cutoffDate.setDate(cutoffDate.getDate() - periodDays);
                data = data.filter(d => new Date(d.date + 'T00:00:00') >= cutoffDate);
            }
            if (dateFrom) data = data.filter(d => d.date >= dateFrom);
            if (dateTo) data = data.filter(d => d.date <= dateTo);
            return data;
        }

        function updateDashboard() {
            const f = getFilteredData();
            updateKPIs(f); updateLastDayComparison(); updateFullWeekComparison(); updateTicketPerBar(f); updateDurationPerBar(f);
            updateCharts(f); updateBestDaysPerBar(f); updateProductsCards(); updateLocationCards(f); updateDetailTable(f);
        }

        function updateKPIs(data) {
            const totalSales = data.reduce((s,d) => s+d.total_sales, 0);
            const totalTickets = data.reduce((s,d) => s+d.total_tickets, 0);
            const avgTicket = totalTickets > 0 ? totalSales / totalTickets : 0;
            const numDays = new Set(data.map(d => d.date)).size;
            const avgPerDay = numDays > 0 ? totalSales / numDays : 0;
            const allDates = [...new Set(data.map(d => d.date))].sort().reverse();
            const last = allDates[0] || null;
            const lastSales = last ? data.filter(d => d.date === last).reduce((s,d) => s+d.total_sales, 0) : 0;
            const lastTickets = last ? data.filter(d => d.date === last).reduce((s,d) => s+d.total_tickets, 0) : 0;
            const lastFmt = last ? new Date(last+'T00:00:00').toLocaleDateString('es-AR',{day:'numeric',month:'short'}) : 'N/A';
            document.getElementById('kpiGrid').innerHTML=`
                <div class="kpi-card hi"><div class="kpi-label">üí∞ √öltimo d√≠a (${lastFmt})</div><div class="kpi-value or">${fmt(lastSales)}</div><div class="kpi-sub">${lastTickets} tickets</div></div>
                <div class="kpi-card"><div class="kpi-label">Ventas totales</div><div class="kpi-value">${fmt(totalSales)}</div><div class="kpi-sub">${data.length} reportes</div></div>
                <div class="kpi-card"><div class="kpi-label">Total tickets</div><div class="kpi-value">${totalTickets.toLocaleString('es-AR')}</div><div class="kpi-sub">En ${numDays} d√≠as</div></div>
                <div class="kpi-card"><div class="kpi-label">Ticket promedio</div><div class="kpi-value">${fmt(avgTicket)}</div><div class="kpi-sub">Por ticket</div></div>
                <div class="kpi-card"><div class="kpi-label">Promedio diario</div><div class="kpi-value">${fmt(avgPerDay)}</div><div class="kpi-sub">Por d√≠a</div></div>`;
        }

        function updateLastDayComparison() {
            const ad = dashboardData.sales_data;
            const locs = Object.keys(dashboardData.locations);
            const toS = d => d.toISOString().slice(0,10);
            const mf = (v) => `<span style="font-family:var(--mono,'Space Mono',monospace);">${fmt(v)}</span>`;

            // Encontrar el √∫ltimo d√≠a con datos (excluyendo hoy para evitar datos parciales)
            const allDates = [...new Set(ad.map(d=>d.date))].sort().reverse();
            const todayStr = new Date().toISOString().slice(0,10);
            const lastDate = allDates.find(d => d !== todayStr) || allDates[0];
            if (!lastDate) { document.getElementById('lastDayComparison').innerHTML = '<p style="color:var(--muted);">Sin datos</p>'; return; }

            // Encontrar el mismo d√≠a de la semana anterior
            const lastDateObj = new Date(lastDate + 'T00:00:00');
            const prevWeekDateObj = new Date(lastDateObj);
            prevWeekDateObj.setDate(lastDateObj.getDate() - 7);
            const prevDate = toS(prevWeekDateObj);

            const dayName = lastDateObj.toLocaleDateString('es-AR', {weekday:'long'});
            const lastFmt = lastDateObj.toLocaleDateString('es-AR', {day:'numeric', month:'short'});
            const prevFmt = prevWeekDateObj.toLocaleDateString('es-AR', {day:'numeric', month:'short'});
            const isWeekend = (lastDateObj.getDay() === 0 || lastDateObj.getDay() === 6);

            let rows = '', tThis = 0, tLast = 0;
            locs.forEach(loc => {
                if (loc === 'COLEGIO' && isWeekend) return;
                const li = dashboardData.locations[loc];
                const ts = ad.filter(d=>d.date===lastDate && d.location===loc).reduce((s,d)=>s+d.total_sales,0);
                const ls = ad.filter(d=>d.date===prevDate && d.location===loc).reduce((s,d)=>s+d.total_sales,0);
                tThis += ts; tLast += ls;
                let pct = ls > 0 ? ((ts-ls)/ls)*100 : (ts > 0 ? 100 : 0);
                const cls = pct>0?'change-positive':pct<0?'change-negative':'change-neutral';
                const sign = pct>0?'+':''; const arr = pct>0?'‚ñ≤':pct<0?'‚ñº':'‚Äî';
                rows += `<tr><td>${li.emoji} ${loc}</td><td>${mf(ts)}</td><td>${mf(ls)}</td><td class="${cls}">${arr} ${sign}${pct.toFixed(1)}%</td></tr>`;
            });
            let tp = tLast>0?((tThis-tLast)/tLast)*100:(tThis>0?100:0);
            const tc = tp>0?'change-positive':tp<0?'change-negative':'change-neutral';
            rows += `<tr style="border-top:2px solid var(--border-hover);font-weight:700;"><td>TOTAL</td><td style="color:var(--teal);">${mf(tThis)}</td><td>${mf(tLast)}</td><td class="${tc}">${tp>0?'‚ñ≤':tp<0?'‚ñº':'‚Äî'} ${tp>0?'+':''}${tp.toFixed(1)}%</td></tr>`;
            document.getElementById('lastDayComparison').innerHTML = `<div class="chart-title">${dayName.charAt(0).toUpperCase()+dayName.slice(1)} ${lastFmt} vs ${prevFmt}</div><table class="weekly-table"><thead><tr><th>Local</th><th>${lastFmt}</th><th>${prevFmt}</th><th>Variaci√≥n</th></tr></thead><tbody>${rows}</tbody></table>`;
        }

        function updateFullWeekComparison() {
            const ad = dashboardData.sales_data;
            const locs = Object.keys(dashboardData.locations);
            const toS = d => d.toISOString().slice(0,10);
            const mf = (v) => `<span style="font-family:var(--mono,'Space Mono',monospace);">${fmt(v)}</span>`;

            // Encontrar el √∫ltimo domingo (fin de semana completa)
            const today = new Date(); today.setHours(0,0,0,0);
            const dow = today.getDay(); // 0=dom
            // Si hoy es domingo, la √∫ltima semana completa termin√≥ hoy; sino, el domingo pasado
            const lastSunday = new Date(today);
            if (dow !== 0) lastSunday.setDate(today.getDate() - dow);
            const lastMonday = new Date(lastSunday); lastMonday.setDate(lastSunday.getDate() - 6);

            const prevSunday = new Date(lastMonday); prevSunday.setDate(lastMonday.getDate() - 1);
            const prevMonday = new Date(prevSunday); prevMonday.setDate(prevSunday.getDate() - 6);

            // Helper: filtrar fines de semana de COLEGIO
            function filterColegioWeekends(data) {
                return data.filter(d => {
                    if (d.location !== 'COLEGIO') return true;
                    const day = new Date(d.date + 'T00:00:00').getDay();
                    return day !== 0 && day !== 6;
                });
            }

            const w1 = filterColegioWeekends(ad.filter(d => d.date >= toS(lastMonday) && d.date <= toS(lastSunday)));
            const w2 = filterColegioWeekends(ad.filter(d => d.date >= toS(prevMonday) && d.date <= toS(prevSunday)));

            const w1Label = `${lastMonday.toLocaleDateString('es-AR',{day:'numeric',month:'short'})} ‚Äì ${lastSunday.toLocaleDateString('es-AR',{day:'numeric',month:'short'})}`;
            const w2Label = `${prevMonday.toLocaleDateString('es-AR',{day:'numeric',month:'short'})} ‚Äì ${prevSunday.toLocaleDateString('es-AR',{day:'numeric',month:'short'})}`;

            let rows = '', tThis = 0, tLast = 0;
            locs.forEach(loc => {
                const li = dashboardData.locations[loc];
                const ts = w1.filter(d=>d.location===loc).reduce((s,d)=>s+d.total_sales,0);
                const ls = w2.filter(d=>d.location===loc).reduce((s,d)=>s+d.total_sales,0);
                tThis += ts; tLast += ls;
                let pct = ls > 0 ? ((ts-ls)/ls)*100 : (ts > 0 ? 100 : 0);
                const cls = pct>0?'change-positive':pct<0?'change-negative':'change-neutral';
                const sign = pct>0?'+':''; const arr = pct>0?'‚ñ≤':pct<0?'‚ñº':'‚Äî';
                rows += `<tr><td>${li.emoji} ${loc}</td><td>${mf(ts)}</td><td>${mf(ls)}</td><td class="${cls}">${arr} ${sign}${pct.toFixed(1)}%</td></tr>`;
            });
            let tp = tLast>0?((tThis-tLast)/tLast)*100:(tThis>0?100:0);
            const tc = tp>0?'change-positive':tp<0?'change-negative':'change-neutral';
            rows += `<tr style="border-top:2px solid var(--border-hover);font-weight:700;"><td>TOTAL</td><td style="color:var(--teal);">${mf(tThis)}</td><td>${mf(tLast)}</td><td class="${tc}">${tp>0?'‚ñ≤':tp<0?'‚ñº':'‚Äî'} ${tp>0?'+':''}${tp.toFixed(1)}%</td></tr>`;
            document.getElementById('fullWeekComparison').innerHTML = `<div class="chart-title">Semana completa: ${w1Label} vs ${w2Label}</div><table class="weekly-table"><thead><tr><th>Local</th><th>${w1Label}</th><th>${w2Label}</th><th>Variaci√≥n</th></tr></thead><tbody>${rows}</tbody></table>`;
        }

        function updateTicketPerBar(data) {
            const locs = Object.keys(dashboardData.locations);
            let html = '<div class="info-grid">';
            locs.forEach(loc => {
                const li = dashboardData.locations[loc];
                const ld = data.filter(d=>d.location===loc);
                const ts = ld.reduce((s,d)=>s+d.total_sales,0);
                const tt = ld.reduce((s,d)=>s+d.total_tickets,0);
                const avg = tt>0?ts/tt:0;
                html += `<div class="info-card"><div class="info-card-emoji">${li.emoji}</div><div class="info-card-data"><div class="info-card-label">${loc}</div><div class="info-card-value">${fmt(avg)}</div><div class="info-card-detail">${tt.toLocaleString('es-AR')} tickets ¬∑ ${fmt(ts)} total</div></div></div>`;
            });
            html += '</div>';
            document.getElementById('ticketPerBar').innerHTML = html;
        }

        function updateDurationPerBar(data) {
            const locs = Object.keys(dashboardData.locations);
            function diffMin(o,c) {
                if(!o||!c||o==='00:00'||c==='00:00') return null;
                const [oh,om]=o.split(':').map(Number), [ch,cm]=c.split(':').map(Number);
                let d=(ch*60+cm)-(oh*60+om); if(d<0) d+=1440; if(d>1080) return null; return d;
            }
            function fmtD(m) { return `${Math.floor(m/60)}h ${Math.round(m%60)}m`; }
            let html = '<div class="info-grid">';
            locs.forEach(loc => {
                const li = dashboardData.locations[loc];
                const durs = data.filter(d=>d.location===loc).map(d=>diffMin(d.opening_time,d.closing_time)).filter(d=>d!==null&&d>0);
                const avg = durs.length>0 ? durs.reduce((a,b)=>a+b,0)/durs.length : 0;
                html += `<div class="info-card"><div class="info-card-emoji">${li.emoji}</div><div class="info-card-data"><div class="info-card-label">${loc}</div><div class="info-card-value orange">${avg>0?fmtD(avg):'Sin datos'}</div><div class="info-card-detail">${durs.length} turnos registrados</div></div></div>`;
            });
            html += '</div>';
            document.getElementById('durationPerBar').innerHTML = html;
        }

        function updateBestDaysPerBar(data) {
            const grid = document.getElementById('bestDaysPerBarGrid'); grid.innerHTML = '';
            Object.keys(dashboardData.locations).forEach(loc => {
                const li = dashboardData.locations[loc];
                const ld = data.filter(d=>d.location===loc);
                const byDate = {}; ld.forEach(d => { byDate[d.date] = (byDate[d.date]||0)+d.total_sales; });
                const top5 = Object.entries(byDate).sort((a,b)=>b[1]-a[1]).slice(0,5);
                if(!top5.length) return;
                const mx = top5[0][1];
                let rh = '';
                top5.forEach(([date,sales],i) => {
                    const d = new Date(date+'T00:00:00');
                    const dn = d.toLocaleDateString('es-AR',{weekday:'short'});
                    const ds = d.toLocaleDateString('es-AR',{day:'numeric',month:'short'});
                    const bw = (sales/mx)*100;
                    const medal = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':`${i+1}.`;
                    rh += `<div style="margin-bottom:12px;"><div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span style="font-size:0.9rem;">${medal} ${dn} ${ds}</span><span style="color:var(--teal,#5aedc5);font-weight:600;font-family:var(--mono,'Space Mono',monospace);">${fmt(sales)}</span></div><div style="background:rgba(44,95,65,0.3);border-radius:4px;height:20px;overflow:hidden;"><div style="background:${locationColors[loc]||'#ff6b35'};width:${bw}%;height:100%;border-radius:4px;"></div></div></div>`;
                });
                const card = document.createElement('div'); card.className = 'chart-card';
                card.innerHTML = `<h3 class="chart-title">${li.emoji} ${loc}</h3><div style="padding:10px 0;">${rh}</div>`;
                grid.appendChild(card);
            });
        }

        function updateCharts(data) { updateSalesTrendChart(data); updateDayOfWeekChart(data); updateTopDaysChart(data); updateSalesByLocationChart(data); updatePaymentMethodsChart(data); updateShiftsComparisonChart(data); }

        function updateSalesTrendChart(data) {
            const ctx = document.getElementById('salesTrendChart').getContext('2d');
            const bdl = {}; data.forEach(d => { if(!bdl[d.date]) bdl[d.date]={}; bdl[d.date][d.location]=(bdl[d.date][d.location]||0)+d.total_sales; });
            const dates = Object.keys(bdl).sort();
            const locs = Object.keys(dashboardData.locations);
            const ds = locs.map(l => ({ label:l, data:dates.map(d=>bdl[d][l]||0), borderColor:locationColors[l], backgroundColor:locationColors[l]+'20', borderWidth:2, tension:0.4 }));
            if(charts.salesTrend) charts.salesTrend.destroy();
            charts.salesTrend = new Chart(ctx, { type:'line', data:{labels:dates,datasets:ds}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:'#e8f5e8'}}}, scales:{ y:{beginAtZero:true,ticks:{color:'#a0b3a0',callback:v=>'$'+v.toLocaleString('es-AR')},grid:{color:'rgba(255,255,255,0.04)'}}, x:{ticks:{color:'#a0b3a0'},grid:{color:'rgba(255,255,255,0.04)'}} } } });
        }

        function updateDayOfWeekChart(data) {
            const ctx = document.getElementById('dayOfWeekChart').getContext('2d');
            const dn=['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
            const sd=[0,0,0,0,0,0,0], cd=[0,0,0,0,0,0,0];
            data.forEach(d => { const dw=new Date(d.date+'T00:00:00').getDay(); sd[dw]+=d.total_sales; cd[dw]++; });
            const avg=sd.map((t,i)=>cd[i]>0?t/cd[i]:0);
            if(charts.dayOfWeek) charts.dayOfWeek.destroy();
            charts.dayOfWeek = new Chart(ctx, { type:'bar', data:{labels:dn,datasets:[{label:'Ventas Promedio',data:avg,backgroundColor:'rgba(90,237,197,0.7)',borderColor:'#5aedc5',borderWidth:2}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{color:'#a0b3a0',callback:v=>'$'+v.toLocaleString('es-AR',{maximumFractionDigits:0})},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#a0b3a0'},grid:{color:'rgba(255,255,255,0.04)'}}}} });
        }

        function updateTopDaysChart(data) {
            const ctx = document.getElementById('topDaysChart').getContext('2d');
            const bd={}; data.forEach(d=>{bd[d.date]=(bd[d.date]||0)+d.total_sales;});
            const sorted=Object.entries(bd).sort((a,b)=>b[1]-a[1]).slice(0,10);
            const dates=sorted.map(([d])=>new Date(d+'T00:00:00').toLocaleDateString('es-AR',{day:'numeric',month:'short'}));
            const vals=sorted.map(([,s])=>s);
            if(charts.topDays) charts.topDays.destroy();
            charts.topDays = new Chart(ctx, { type:'bar', data:{labels:dates,datasets:[{label:'Ventas',data:vals,backgroundColor:'rgba(240,184,96,0.7)',borderColor:'#f0b860',borderWidth:2}]}, options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{beginAtZero:true,ticks:{color:'#a0b3a0',callback:v=>'$'+v.toLocaleString('es-AR',{maximumFractionDigits:0})},grid:{color:'rgba(255,255,255,0.04)'}},y:{ticks:{color:'#a0b3a0'},grid:{color:'rgba(255,255,255,0.04)'}}}} });
        }

        function updateSalesByLocationChart(data) {
            const ctx = document.getElementById('salesByLocationChart').getContext('2d');
            const bl={}; data.forEach(d=>{bl[d.location]=(bl[d.location]||0)+d.total_sales;});
            const locs=Object.keys(bl), vals=locs.map(l=>bl[l]), cols=locs.map(l=>locationColors[l]);
            if(charts.byLocation) charts.byLocation.destroy();
            charts.byLocation = new Chart(ctx, { type:'bar', data:{labels:locs,datasets:[{label:'Ventas',data:vals,backgroundColor:cols,borderColor:cols,borderWidth:2}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{color:'#a0b3a0',callback:v=>'$'+v.toLocaleString('es-AR')},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#a0b3a0'},grid:{color:'rgba(255,255,255,0.04)'}}}} });
        }

        function updatePaymentMethodsChart(data) {
            const ctx = document.getElementById('paymentMethodsChart').getContext('2d');
            const t={'Efectivo':data.reduce((s,d)=>s+d.cash_sales,0),'Tarjeta':data.reduce((s,d)=>s+d.card_sales,0),'Transferencia':data.reduce((s,d)=>s+d.transfer_sales,0),'MercadoPago':data.reduce((s,d)=>s+d.mercadopago_sales,0),'Otros':data.reduce((s,d)=>s+d.other_sales,0)};
            if(charts.paymentMethods) charts.paymentMethods.destroy();
            charts.paymentMethods = new Chart(ctx, { type:'doughnut', data:{labels:Object.keys(t),datasets:[{data:Object.values(t),backgroundColor:['#ff6b35','#64ffda','#ffa726','#00d084','#9c27b0'],borderWidth:2,borderColor:'#1a1f1a'}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#e8f5e8'},position:'bottom'},tooltip:{callbacks:{label:c=>`${c.label}: ${fmt(c.parsed)}`}}}} });
        }

        function updateShiftsComparisonChart(data) {
            const ctx = document.getElementById('shiftsComparisonChart').getContext('2d');
            const gd=data.filter(d=>d.location==='GROWLER CAFE');
            const bs={'Ma√±ana':gd.filter(d=>d.shift==='Ma√±ana').reduce((s,d)=>s+d.total_sales,0),'Tarde':gd.filter(d=>d.shift==='Tarde').reduce((s,d)=>s+d.total_sales,0)};
            if(charts.shifts) charts.shifts.destroy();
            charts.shifts = new Chart(ctx, { type:'bar', data:{labels:['Ma√±ana','Tarde'],datasets:[{label:'Ventas por Turno',data:Object.values(bs),backgroundColor:['#ffa726','#ff6b35'],borderColor:['#ffa726','#ff6b35'],borderWidth:2}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{color:'#a0b3a0',callback:v=>'$'+v.toLocaleString('es-AR')},grid:{color:'rgba(255,255,255,0.04)'}},x:{ticks:{color:'#a0b3a0'},grid:{color:'rgba(255,255,255,0.04)'}}}} });
        }

        function updateLocationCards(data) {
            const grid = document.getElementById('locationsGrid'); grid.innerHTML = '';
            Object.keys(dashboardData.locations).forEach(ln => {
                const ld=data.filter(d=>d.location===ln), li=dashboardData.locations[ln];
                const ts=ld.reduce((s,d)=>s+d.total_sales,0), tt=ld.reduce((s,d)=>s+d.total_tickets,0), at=tt>0?ts/tt:0;
                const card=document.createElement('div'); card.className='location-card';
                card.innerHTML=`<div class="location-header" onclick="toggleLocation('${ln}')"><div><div class="location-name">${li.emoji} ${ln}</div><div style="font-size:0.85rem;opacity:0.9;">${li.address}</div></div><div class="toggle-icon" id="toggle-${ln}">‚ñº</div></div><div class="location-body" id="body-${ln}"><div class="location-stat"><span class="stat-label">Ventas Totales</span><span class="stat-value">${fmt(ts)}</span></div><div class="location-stat"><span class="stat-label">Total Tickets</span><span class="stat-value">${tt}</span></div><div class="location-stat"><span class="stat-label">Ticket Promedio</span><span class="stat-value">${fmt(at)}</span></div><div class="location-stat"><span class="stat-label">Reportes</span><span class="stat-value">${ld.length}</span></div>${li.shifts===2?'<div class="location-stat"><span class="stat-label">Turnos</span><span class="stat-value">2 (Ma√±ana/Tarde)</span></div>':''}</div>`;
                grid.appendChild(card);
            });
        }

        function updateProductsCards() {
            const grid = document.getElementById('productsGrid'); grid.innerHTML = '';
            if(!dashboardData.top_products) return;
            Object.keys(dashboardData.top_products).forEach(ln => {
                const products=dashboardData.top_products[ln], li=dashboardData.locations[ln];
                if(!products||!products.length) return;
                const card=document.createElement('div'); card.className='chart-card'; card.style.minHeight='350px';
                let ph='';
                products.forEach((p,i)=>{
                    const bw=(p.quantity/products[0].quantity)*100;
                    ph+=`<div style="margin-bottom:15px;"><div style="display:flex;justify-content:space-between;margin-bottom:5px;"><span style="font-size:0.9rem;">${i+1}. ${p.name}</span><span style="color:#ff6b35;font-weight:bold;">${p.quantity.toFixed(0)} unidades</span></div><div style="display:flex;align-items:center;gap:10px;"><div style="flex:1;background:rgba(44,95,65,0.3);border-radius:4px;height:25px;overflow:hidden;"><div style="background:linear-gradient(90deg,#2c5f41,#ff6b35);width:${bw}%;height:100%;border-radius:4px;transition:width 0.3s ease;"></div></div><span style="font-size:0.85rem;color:#a0b3a0;min-width:90px;text-align:right;">${fmt(p.total_amount/100)}</span></div></div>`;
                });
                card.innerHTML=`<h3 class="chart-title">${li.emoji} ${ln}</h3><div style="padding:20px;">${ph}</div>`;
                grid.appendChild(card);
            });
        }

        function toggleLocation(ln) { document.getElementById(`body-${ln}`).classList.toggle('active'); document.getElementById(`toggle-${ln}`).classList.toggle('rotated'); }

        function updateDetailTable(data) {
            const tbody=document.querySelector('#detailTable tbody'); tbody.innerHTML='';
            [...data].sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(s => {
                const row=document.createElement('tr');
                row.innerHTML=`<td>${s.date}</td><td>${dashboardData.locations[s.location].emoji} ${s.location}</td><td>${s.shift}</td><td style="color:var(--teal,#5aedc5);font-weight:600;font-family:var(--mono,'Space Mono',monospace);">${fmt(s.total_sales)}</td><td>${s.total_tickets}</td><td>${fmt(s.cash_sales)}</td><td>${fmt(s.card_sales)}</td><td>${fmt(s.other_sales)}</td>`;
                tbody.appendChild(row);
            });
        }

        loadData();
        setInterval(loadData, 5 * 60 * 1000);
    </script>
</body>
</html>
